import { KeystoreContext } from "../typing";
import { Middleware } from "@lindorm-io/koa";
import { WebKeyHandler } from "../class";
import { flatten } from "lodash";

interface Options {
  baseUrl: string;
  clientName: string;
}

export const jwksKeysMiddleware =
  (options: Options): Middleware<KeystoreContext> =>
  async (ctx, next): Promise<void> => {
    const start = Date.now();

    const handler = new WebKeyHandler({
      baseUrl: options.baseUrl,
      logger: ctx.logger,
      name: options.clientName,
    });

    const keys = await handler.getKeys();

    ctx.keys = flatten([ctx.keys, keys]);

    ctx.logger.debug("keys found on client", {
      baseUrl: options.baseUrl,
      client: options.clientName,
      amount: keys.length,
      total: ctx.keys.length,
    });

    ctx.metrics.keystore = (ctx.metrics.keystore || 0) + (Date.now() - start);

    await next();
  };
